<!DOCTYPE html>
<html lang="en">
    <head>
        <!-- CSS only -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor"
            crossorigin="anonymous">
            <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
        <!-- <script src="https://requirejs.org/docs/release/2.3.5/minified/require.js"></script> -->
        <meta charset="UTF-8">
        <title>Noteunlimited Demo API</title>
    </head>
    <script>
var ACCESS_TOKEN = "";
var BACKEND_URL = "http://127.0.0.1:5003";
var API_URL = "http://127.0.0.1:5001";
window.onload = function(){
    get_access_token()
    getNoteData();
    
};
var noteList = [];
function getNoteData(){
    var theUrl = BACKEND_URL + "/get_notes";
    fetch(theUrl, {
        method: 'get',
        headers: {
            'Content-Type': 'application/json'
        },
    }).then(response => response.text())
    .then( function(text) {
    console.log('Response', text);
    data = JSON.parse(text);
    noteList = JSON.parse(text);
    var _tr_ = document.createElement('tr'),
        _th_ = document.createElement('th'),
        _td_ = document.createElement('td');

    _th_.classList.add("align-text-top")

    var row = data[0];
    var headers = Object.keys(row);
    var headerEl = document.getElementById("header");
    var tableBodyEl = document.getElementById("tableBody");
    var thAction = _th_.cloneNode(false);
    thAction.appendChild(document.createTextNode("Action"));
    headerEl.appendChild(thAction);
    for(var i = 0; i<headers.length; i++) {
        var th = _th_.cloneNode(false);
        th.appendChild(document.createTextNode(headers[i]));
        headerEl.appendChild(th);
    }

    for(var i = 0; i<data.length; i++) {
        var tr = _tr_.cloneNode(false);
        var a = document.createElement('a');
        var linkText = document.createTextNode("Show Report");
        a.appendChild(linkText);
        a.title = "Show Report On Noteunlimited.com";
        a.href = "javascript:void(0);";
        if(i==0)
           {
            a.onclick = function() { send_note(0) };
           }
            else{
                a.onclick = function() { send_note(1) };
            }
        var td = _td_.cloneNode(false);
        td.appendChild(a);
        td.id = "td_"+i;
        tr.appendChild(td);
        for (const [key, value] of Object.entries(data[i])) {
            var td = _td_.cloneNode(false);
            td.appendChild(document.createTextNode(value || ''));
            tr.appendChild(td);
        }
        tableBodyEl.appendChild(tr)
    }
    


    
    }) 
}


function get_access_token(){
    var theUrl = BACKEND_URL + "/get_access_token";
    fetch(theUrl, {
        method: 'get',
        headers: {
            'Content-Type': 'application/json'
        },
    }).then(response => response.text())
    .then( function(text) {
    console.log('Response', text);
    resToken = JSON.parse(text)
    sessionStorage.setItem('token', resToken["token"]);
    ACCESS_TOKEN = resToken["token"];
    }) 
}
async function get_status(key){
    var theUrl = API_URL + "request-status/"+key;  
    await fetch(theUrl, {
    method: 'GET',
    mode: 'cors',
    headers: {
        'Content-Type': 'application/json',
        'Bearer':ACCESS_TOKEN
    }}).then(response => response.json())
        .then(function(json) {

        }).catch(function(err) {
            console.log(err)
        })
   
}
async function send_note(index){

    $("#loadMe").modal({
      backdrop: "static", //remove ability to close modal with click
      keyboard: false, //remove option to close with keyboard
      show: true //Display loader!
    });

    var theUrl = API_URL + "analyze-note";  
    note_data = {
        "user_email": "support@noteunlimited.com",
        "note":noteList[index]
    }.then(response => response.json())
        .then(function(json) {
            if("report_url" in json){
                let a= document.createElement('a');
                a.target= '_blank';
                a.href= json["report_url"][0];
                a.click();
                let ab= document.createElement('a');
                ab.target= '_blank';
                ab.href= json["report_url"][1];
                ab.click();
            }
        }).catch(function(err) {
            console.log(err)
        })
    await fetch(theUrl, {
    method: 'POST',
    mode: 'cors',
    headers: {
        'Content-Type': 'application/json',
        'Bearer':ACCESS_TOKEN
    },
    body: JSON.stringify(note_data)
    }).then(response => response.json())
        .then(function(json) {
            if("report_url" in json){
                var td = document.getElementById("td_"+index);
                while (td.firstChild) {
                    td.firstChild.remove()
                }
                let a= document.createElement('a');
                var linkText = document.createTextNode("Show Reddeming Report");
                a.appendChild(linkText);
                a.target= '_blank';
                a.href= json["report_url"][0];
                let ab= document.createElement('a');
                var linkText = document.createTextNode("Show Summary Report");
                ab.appendChild(linkText);
                ab.target= '_blank';
                ab.href= json["report_url"][1];
                td.appendChild(a);
                let br= document.createElement('br');
                td.appendChild(br);
                td.appendChild(ab);
                $("#loadMe").modal("hide");
            }
        }).catch(function(err) {
            console.log(err)
        })

        
}
</script>
    <body>
        <div class="container">
            <div class="row">
                <h3>Notes</h3>
            </div>
            <div class="row" style="padding-top:
                1.25vw">
                <div class="table-responsive">
                    <table class="table" id="table">
                        <thead>
                            <tr id="header">

                            </tr>
                        </thead>
                        <tbody id="tableBody">

                        </tbody>
                    </table>
                </div>
                <!-- <div class="col-6">
                    <form class="row g-3">
                        <div class="form-group col-md-6">
                            <label for="inputMethod">Method</label>
                            <select id="inputMethod" class="form-select">
                                <option value="get">GET</option>
                                <option value="post" selected>POST</option>
                            </select>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="inputAction">Action</label>
                            <select id="inputAction" class="form-select">
                                <option value="analysis_note" selected>Analysis
                                    Note</option>
                                <option value="import_note">Import</option>
                            </select>
                        </div>
                        <div class="form-group col-12">
                            <label for="noteParams">Note params in Json object</label>
                            <textarea class="form-control"
                                id="noteParams" rows="5"></textarea>
                        </div>

                        <!-- <div class="form-group">
                            <label for="noteFile">Select file whith Note</label>
                            <input type="file" class="form-control-file"
                                id="noteFile">
                        </div> 
                        <div class="form-group col-md-6 ">
                            <button type="button" onclick="send_note()"
                                class="btn
                                btn-primary btn-block mb-4">
                                Send Request
                            </button>
                        </div>
                    </form>

                </div>
                <div class="col-6">
                    <div class="form-group">
                        <label for="noteParams">Result</label>
                        <textarea class="form-control" rows="10"
                            id="noteParams" rows="3"></textarea>
                    </div>

                </div> -->
            </div>
        </div>
        <!-- Modal -->
        <div class="modal fade" id="loadMe" tabindex="-1" role="dialog"
            aria-labelledby="loadMeLabel">
            <div class="modal-dialog modal-sm" role="document">
                <div class="modal-content">
                    <div class="modal-body text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                          </div>
                        <div clas="loader-txt">
                            <p>Reports are generated...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
